stage('git Progress') {
    git branch: 'github_to_ecr', credentialsId: 'my-git-credential', url: 'https://github.com/ggue/fakejenkins.git'
}

stage('Build container image and Push') {
    sh 'rm -f ~/.dockercfg ~/.docker/config.json || true'

    // configure registry
    docker.withRegistry('https://179460961317.dkr.ecr.ap-northeast-2.amazonaws.com/fake-ecr', 'ecr:ap-northeast-2:my-aws-credential') {
    //build image
    def customImage = docker.build("179460961317.dkr.ecr.ap-northeast-2.amazonaws.com/fake-ecr:${env.BUILD_ID}")
    // push image
    customImage.push()
  }
}

stage('commit container tag to yaml') {
    sh 'rm -f ./*'
	git credentialsId: 'my-git-credential', url: 'https://github.com/ggue/fakeargocd.git'
	
	dir('fake-ecr') {
	    def ecrReop = "179460961317.dkr.ecr.ap-northeast-2.amazonaws.com\\fake-ecr"
		sh "cat fake-ecr.yaml | sed -i \'s/${ecrRepo}:.*\$/${ecrRepo}:${env.BUILD_ID}/g\' fake-ecr.yaml
	}

withCredentials([usernamePassword(credentialsId: 'my-git-credential', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')

	sh "git config --global credential.username $GIT_USER"
	sh "git config --global credential.helper '!f() { echo password=$GIT_PASSWORD; }; f'"
	sh 'git config --global user.email "jenkins@example.com"'
	sh 'git config --global user.name "jenkins"'
	
	sh "git add fake-ecr/fake-ecr.yaml"
	sh "git commit -m 'change container image tag ${env.BUILD_ID}'"
	sh "git push 'https://github.com/ggue/fakeargocd'"
}